<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SyncPlay Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .brand-gradient { background: linear-gradient(90deg, #06b6d4 0%, #7c3aed 50%, #10b981 100%); }
    .logo-shape { width:48px; height:48px; display:inline-grid; place-items:center; border-radius:12px; }
    .logo-text { font-weight:700; letter-spacing:-0.02em; }
    .soft-glow { box-shadow: 0 6px 24px rgba(16,185,129,0.12); }

    /* Watermark */
    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 14px;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.15); /* semitransparente */
      pointer-events: none; /* no interfiere con clicks */
      z-index: 9999;
      letter-spacing: 1px;
      font-family: monospace;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-900 text-white flex flex-col">

  <!-- Header -->
  <header class="flex items-center gap-4 p-4 bg-slate-800 shadow-lg">
    <!-- Logo -->
    <div class="logo-shape brand-gradient soft-glow">
      <span class="text-white font-bold text-xl">SP</span>
    </div>
    <!-- Title -->
    <div>
      <h1 class="text-2xl text-cyan-300 logo-text">SyncPlay</h1>
      <p class="text-xs text-slate-400">Watch together • cyan · purple · emerald</p>
    </div>
    <!-- Room info -->
    <div class="ml-auto flex items-center gap-4">
      <span id="room-id-display" class="text-gray-300 text-sm"></span>
      <button id="leave-room" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
        <i class="fas fa-sign-out-alt"></i> Leave
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="flex flex-1 flex-col md:flex-row p-4 gap-4">

    <!-- Video Player -->
    <section class="flex-1 bg-slate-800 rounded-xl overflow-hidden flex flex-col shadow-md">
      <!-- Creator Controls -->
      <div id="video-controls" class="p-3 border-b border-slate-700 flex gap-2">
        <input id="video-url" type="text" placeholder="Paste YouTube URL"
          class="flex-1 p-2 rounded bg-slate-700 text-white text-sm"/>
        <button id="load-video" class="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded text-sm">
          <i class="fas fa-play"></i> Load
        </button>
      </div>

      <!-- Viewer Align Button -->
      <div id="align-controls" class="p-3 border-b border-slate-700 hidden">
        <button id="align-video" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded text-sm w-full">
          🔄 Align with Creator
        </button>
      </div>

      <!-- Video Container -->
      <div id="video-container" class="relative w-full bg-black aspect-video">
        <div id="player"></div>
      </div>
    </section>

    <!-- Chat Sidebar -->
    <aside class="w-full md:w-1/3 flex flex-col bg-slate-800 rounded-xl shadow-md max-h-[calc(100vh-120px)]">
      <!-- Chat Header -->
      <div class="p-3 border-b border-slate-700 flex justify-between items-center">
        <span class="font-bold text-cyan-300">💬 Chat</span>
        <span id="user-count" class="text-gray-400 text-xs">0 online</span>
      </div>
      <!-- User name -->
      <div class="p-2 border-b border-slate-700 text-sm">
        <span class="text-gray-400">Your name: </span>
        <span id="user-name" class="cursor-pointer underline text-emerald-400"></span>
      </div>
      <!-- Chat Messages -->
      <div id="chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 text-sm bg-slate-900"></div>
      <!-- Chat Input -->
      <div class="p-2 border-t border-slate-700 flex gap-2">
        <input id="chat-input" type="text" placeholder="Type a message..."
          class="flex-1 p-2 rounded bg-slate-700 text-white text-sm"/>
        <button id="send-chat" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </aside>
  </main>

  <!-- Watermark -->
  <div class="watermark">Xtremo Developer®</div>

  <!-- Firebase + Logic -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, runTransaction, update, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDEVWAQ4eIoi2NvbYj7XeFrsgCaiCZj0uc",
      authDomain: "ecosalas-25261.firebaseapp.com",
      databaseURL: "https://ecosalas-25261-default-rtdb.firebaseio.com",
      projectId: "ecosalas-25261",
      storageBucket: "ecosalas-25261.firebasestorage.app",
      messagingSenderId: "406797661209",
      appId: "1:406797661209:web:260d6d3890a4342beba688",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Room and Role
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("id");
    const isCreator = params.get("creator") === "true"; 

    if (!roomId) {
      alert("❌ No room ID provided");
      window.location.href = "index.html";
    }
    document.getElementById("room-id-display").innerText = "Room: " + roomId;

    if (!isCreator) {
      document.getElementById("video-controls").style.display = "none";
      document.getElementById("align-controls").style.display = "block";
    }

    // Username editable
    let userName = isCreator ? "👑 Creator" : "🙋 Viewer";
    const userNameSpan = document.getElementById("user-name");
    userNameSpan.textContent = userName;

    userNameSpan.addEventListener("click", () => {
      const newName = prompt("Escribe tu nuevo nombre (máx. 13 caracteres):", userName.replace("👑 ", "").replace("🙋 ", ""));
      if (newName !== null) {
        const trimmed = newName.trim().slice(0, 13);
        userName = (isCreator ? "👑 " : "🙋 ") + (trimmed || (isCreator ? "Creator" : "Viewer"));
        userNameSpan.textContent = userName;
      }
    });

    // User counter
    const userCountRef = ref(db, "rooms/" + roomId + "/users");
    runTransaction(userCountRef, (current) => (current || 0) + 1);

    onValue(userCountRef, (snap) => {
      const count = snap.val() || 0;
      document.getElementById("user-count").innerText = count + " online";
    });

    window.addEventListener("beforeunload", () => {
      runTransaction(userCountRef, (current) => (current || 1) - 1);
    });

    // Chat
    const chatRef = ref(db, "rooms/" + roomId + "/chat");
    const chatBox = document.getElementById("chat-messages");

    onValue(chatRef, (snap) => {
      chatBox.innerHTML = "";
      snap.forEach((msg) => {
        const data = msg.val();
        const div = document.createElement("div");
        div.className = "bg-slate-700 p-2 rounded break-words";
        div.innerHTML = `
          <span class="text-emerald-400 font-bold">${data.user}</span> 
          <span class="text-gray-400 text-xs">[${new Date(data.time).toLocaleTimeString()}]</span><br>
          ${data.text}
        `;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById("send-chat").addEventListener("click", sendMessage);
    document.getElementById("chat-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const input = document.getElementById("chat-input");
      if (!input.value.trim()) return;
      push(chatRef, {
        user: userName,
        text: input.value.trim(),
        time: Date.now()
      });
      input.value = "";
    }

    // Video Sync
    let player;
    let syncInterval;
    const videoRef = ref(db, "rooms/" + roomId + "/video");

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player("player", {
        height: "100%",
        width: "100%",
        videoId: "",
        events: {
          onReady: () => console.log("✅ Player ready"),
          onStateChange: handlePlayerState
        }
      });
    };

    function handlePlayerState(event) {
      if (!isCreator) return;

      if (event.data === YT.PlayerState.PLAYING) {
        update(videoRef, { time: player.getCurrentTime(), action: "play" });
        syncInterval = setInterval(() => {
          update(videoRef, { time: player.getCurrentTime(), action: "play" });
        }, 2000);
      } else if (event.data === YT.PlayerState.PAUSED) {
        clearInterval(syncInterval);
        update(videoRef, { time: player.getCurrentTime(), action: "pause" });
      }
    }

    if (isCreator) {
      document.getElementById("load-video").addEventListener("click", () => {
        const url = document.getElementById("video-url").value.trim();
        if (!url) return;
        const vid = extractVideoId(url);
        set(videoRef, { url: url, videoId: vid, action: "pause", time: 0 });
        player.loadVideoById(vid);
      });
    }

    // Viewers auto align
    onValue(videoRef, (snap) => {
      const data = snap.val();
      if (!data || isCreator || !player) return;

      if (data.videoId && player.getVideoData().video_id !== data.videoId) {
        player.loadVideoById(data.videoId, data.time || 0);
      } else {
        const diff = Math.abs(player.getCurrentTime() - data.time);
        if (diff > 1) player.seekTo(data.time, true);
      }

      if (data.action === "play") player.playVideo();
      else player.pauseVideo();
    });

    // Manual Align
    if (!isCreator) {
      document.getElementById("align-video").addEventListener("click", async () => {
        const snap = await get(videoRef);
        if (snap.exists()) {
          const data = snap.val();
          if (data && player) {
            player.seekTo(data.time, true);
            if (data.action === "play") player.playVideo();
            else player.pauseVideo();
          }
        }
      });
    }

    // Extract VideoId
    function extractVideoId(url) {
      try {
        const u = new URL(url);
        if (u.hostname.includes("youtu.be")) {
          return u.pathname.replace("/", "");
        }
        if (u.searchParams.has("v")) {
          return u.searchParams.get("v");
        }
      } catch (e) {
        const regExp = /(?:youtube\.com.*(?:\?|&)v=|youtu\.be\/)([^&#]+)/;
        const match = url.match(regExp);
        return match ? match[1] : "";
      }
      return "";
    }

    // Leave room
    document.getElementById("leave-room").addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
