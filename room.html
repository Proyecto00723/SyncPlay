// --- Video Sync ---
let player;
const videoRef = ref(db, "rooms/" + roomId + "/video");

window.onYouTubeIframeAPIReady = () => {
  player = new YT.Player("player", {
    height: "100%",
    width: "100%",
    videoId: "",
    events: {
      onReady: () => {
        console.log("✅ Player ready");
        // Forzar a viewers a cargar video cuando entren
        if (!isCreator) {
          onValue(videoRef, (snap) => {
            const data = snap.val();
            if (data && data.videoId) {
              player.loadVideoById(data.videoId, data.time || 0);
              if (data.action === "play") player.playVideo();
              else player.pauseVideo();
            }
          }, { onlyOnce: true });
        }
      },
      onStateChange: handlePlayerState
    }
  });
};

function handlePlayerState(event) {
  if (isCreator) {
    if (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED) {
      update(videoRef, {
        time: player.getCurrentTime(),
        action: event.data === YT.PlayerState.PLAYING ? "play" : "pause"
      });
    }
  }
}

// Función universal para extraer ID
function extractVideoId(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes("youtu.be")) {
      return u.pathname.replace("/", "");
    }
    if (u.searchParams.get("v")) {
      return u.searchParams.get("v");
    }
  } catch (e) {
    const regExp = /(?:youtube\.com.*(?:\?|&)v=|youtu\.be\/)([^&#]+)/;
    const match = url.match(regExp);
    return match ? match[1] : "";
  }
  return "";
}

if (isCreator) {
  const loadVideo = (url) => {
    if (!url) return;
    const vid = extractVideoId(url);
    if (!vid) return alert("❌ Invalid YouTube URL");

    set(videoRef, { url, videoId: vid, action: "pause", time: 0 });
    player.loadVideoById(vid);
  };

  document.getElementById("load-video-1").addEventListener("click", () => {
    loadVideo(document.getElementById("video-url-1").value.trim());
  });

  document.getElementById("load-video-2").addEventListener("click", () => {
    loadVideo(document.getElementById("video-url-2").value.trim());
  });
}

// --- Viewers: sync con creator ---
let lastVideoId = null;
onValue(videoRef, (snap) => {
  const data = snap.val();
  if (!data) return;

  if (!isCreator && data.videoId) {
    if (player && player.loadVideoById) {
      if (lastVideoId !== data.videoId) {
        // 🔄 Forzar carga si es un nuevo video
        player.loadVideoById(data.videoId, data.time || 0);
        lastVideoId = data.videoId;
      } else {
        // Solo sincronizar estado y tiempo
        player.seekTo(data.time || 0, true);
        if (data.action === "play") player.playVideo();
        else player.pauseVideo();
      }
    }
  }
});
