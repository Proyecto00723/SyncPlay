<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SyncPlay Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body class="min-h-screen bg-slate-900 text-white flex flex-col">

  <!-- Header -->
  <header class="bg-slate-800 p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-cyan-400">SyncPlay</h1>
    <div class="flex items-center gap-4">
      <span id="room-id-display" class="text-gray-300"></span>
      <button id="leave-room" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded">
        <i class="fas fa-sign-out-alt"></i> Leave
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="flex flex-1 flex-col md:flex-row p-4 gap-4">
    
    <!-- Video -->
    <section class="flex-1 bg-black rounded-lg overflow-hidden flex flex-col">
      <!-- Controles de video (solo creador) -->
      <div id="video-controls" class="p-2 bg-slate-800 flex flex-col gap-2">
        <div class="flex gap-2">
          <input id="video-url" type="text" placeholder="Paste YouTube URL"
            class="flex-1 p-2 rounded bg-slate-700 text-white"/>
          <button id="load-video" class="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded">
            <i class="fas fa-play"></i> Load
          </button>
        </div>
      </div>

      <!-- Botón de alineación (solo viewers) -->
      <div id="align-controls" class="p-2 bg-slate-800 hidden">
        <button id="align-video" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded">
          🔄 Align with Creator
        </button>
      </div>

      <!-- Contenedor del video -->
      <div id="video-container" class="relative w-full bg-slate-950 aspect-video">
        <div id="player"></div>
      </div>
    </section>

    <!-- Chat -->
    <aside class="w-full md:w-1/3 flex flex-col bg-slate-800 rounded-lg max-h-[calc(100vh-120px)]">
      <div class="p-2 border-b border-slate-700 flex justify-between">
        <span class="font-bold">💬 Chat</span>
        <span id="user-count" class="text-gray-400 text-sm">0 online</span>
      </div>

      <!-- Mensajes -->
      <div id="chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 text-sm"></div>

      <!-- Input -->
      <div class="p-2 border-t border-slate-700 flex gap-2">
        <input id="chat-input" type="text" placeholder="Type a message..."
          class="flex-1 p-2 rounded bg-slate-700 text-white text-sm"/>
        <button id="send-chat" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </aside>
  </main>

  <!-- Firebase + Logic -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, runTransaction, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDEVWAQ4eIoi2NvbYj7XeFrsgCaiCZj0uc",
      authDomain: "ecosalas-25261.firebaseapp.com",
      databaseURL: "https://ecosalas-25261-default-rtdb.firebaseio.com",
      projectId: "ecosalas-25261",
      storageBucket: "ecosalas-25261.firebasestorage.app",
      messagingSenderId: "406797661209",
      appId: "1:406797661209:web:260d6d3890a4342beba688",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Room & Role ---
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("id");
    const isCreator = params.get("creator") === "true"; 

    if (!roomId) {
      alert("❌ No room ID provided");
      window.location.href = "index.html";
    }
    document.getElementById("room-id-display").innerText = "Room: " + roomId;

    if (!isCreator) {
      document.getElementById("video-controls").style.display = "none";
      document.getElementById("align-controls").style.display = "block";
    }

    // --- User counter ---
    const userCountRef = ref(db, "rooms/" + roomId + "/users");
    runTransaction(userCountRef, (current) => (current || 0) + 1);

    onValue(userCountRef, (snap) => {
      const count = snap.val() || 0;
      document.getElementById("user-count").innerText = count + " online";
    });

    window.addEventListener("beforeunload", () => {
      runTransaction(userCountRef, (current) => (current || 1) - 1);
    });

    // --- Chat ---
    const chatRef = ref(db, "rooms/" + roomId + "/chat");
    const chatBox = document.getElementById("chat-messages");

    onValue(chatRef, (snap) => {
      chatBox.innerHTML = "";
      snap.forEach((msg) => {
        const data = msg.val();
        const div = document.createElement("div");
        div.className = "bg-slate-700 p-2 rounded break-words";
        div.innerHTML = `
          <span class="text-cyan-300 font-bold">${data.user}</span> 
          <span class="text-gray-400 text-xs">[${new Date(data.time).toLocaleTimeString()}]</span><br>
          ${data.text}
        `;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById("send-chat").addEventListener("click", sendMessage);
    document.getElementById("chat-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const input = document.getElementById("chat-input");
      if (!input.value.trim()) return;
      push(chatRef, {
        user: isCreator ? "👑 Creator" : "🙋 Viewer",
        text: input.value.trim(),
        time: Date.now()
      });
      input.value = "";
    }

    // --- Video Sync ---
    let player;
    const videoRef = ref(db, "rooms/" + roomId + "/video");

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player("player", {
        height: "100%",
        width: "100%",
        videoId: "",
        events: {
          onReady: () => console.log("✅ Player ready"),
          onStateChange: handlePlayerState
        }
      });
    };

    function handlePlayerState(event) {
      if (isCreator) {
        if (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED) {
          update(videoRef, {
            time: player.getCurrentTime(),
            action: event.data === YT.PlayerState.PLAYING ? "play" : "pause"
          });
        }
      }
    }

    if (isCreator) {
      document.getElementById("load-video").addEventListener("click", () => {
        const url = document.getElementById("video-url").value.trim();
        if (!url) return;
        const vid = extractVideoId(url);
        console.log("Saving video:", { url, videoId: vid }); // 🔍 Debug
        set(videoRef, { url: url, videoId: vid, action: "pause", time: 0 });
        player.loadVideoById(vid);
      });
    }

    // Viewers: sync con creator
    onValue(videoRef, (snap) => {
      const data = snap.val();
      if (!data) return;

      if (!isCreator && data.videoId) {
        console.log("Viewer syncing video:", data); // 🔍 Debug
        if (player && player.loadVideoById) {
          player.loadVideoById(data.videoId, data.time || 0);
          if (data.action === "play") player.playVideo();
          else player.pauseVideo();
        }
      }
    });

    // Botón de alinear (viewer)
    document.getElementById("align-video").addEventListener("click", () => {
      onValue(videoRef, (snap) => {
        const data = snap.val();
        if (data && !isCreator) {
          player.seekTo(data.time || 0, true);
          if (data.action === "play") player.playVideo();
          else player.pauseVideo();
        }
      }, { onlyOnce: true });
    });

    // --- Extract VideoId robusto ---
    function extractVideoId(url) {
      try {
        const u = new URL(url);

        if (u.hostname.includes("youtu.be")) {
          return u.pathname.replace("/", "");
        }
        if (u.searchParams.has("v")) {
          return u.searchParams.get("v");
        }
      } catch (e) {
        const regExp = /(?:youtube\.com.*(?:\?|&)v=|youtu\.be\/)([^&#]+)/;
        const match = url.match(regExp);
        return match ? match[1] : "";
      }
      return "";
    }

    // --- Leave room ---
    document.getElementById("leave-room").addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
